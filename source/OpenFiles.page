Menu="SystemInformation"
Type="xmenu"
Title="Open Files"
Icon="open.files.png"
Tabs="true"
---
<?PHP
/* Copyright 2015, Dan Landon.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>

<?
require_once("/usr/local/emhttp/plugins/open.files/include/OpenFiles.php");
?>

<table class='tablesorter shift share_status small' id='tblOpenFiles'>
<thead><tr><th width='8%'>Program&nbsp;<strong>*<strong></th><th width='8%'>Process ID</th><th width='6%'>Open Files</th><th width='20%'>Files that may prevent unRAID shutdown</th><th width='auto'>File Name and Path</th></tr></thead>
<tbody id="streams"><?echo(ofiles());?></tbody>
</table><p><strong>
* An entry for 'bash' means you have a terminal session open with the working directory on the array.
</p>
<p>
* If 'smbd' is listed, it means that another computer has a samba share mounted. Files open by Samba usually won't prevent array shutdown.
</strong></p>
<div>
	<blockquote class='inline_help'>
	<p>Click on the 'Kill' button to stop the process that is holding the files open.  A dialog box will open showing you the progress of killing the process holding those files open.</p>
	<p>Click on 'Program', Process ID', or 'File Name or Path' to change the sort order.</p>
	</blockquote>
</div>
<input type="button" value="Refresh" onclick="refresh()">
<input type="button" value="Done" onclick="done()">
<div>
	<strong>*** Troubleshooting shutdown problems. ***</strong>
<?if ($var['mdState']=="STARTED"):?>
	<p>Click 'Help' for an explanation of how this procedure works.</p>
	<blockquote class='inline_help'>
	<p>The 'Stop Array Processes' will stop all processes on the array.
	The 'Stop Array Processes' is the same as when you stop the array at the webgui, except the array is not stopped.
	This puts the system in the state of a normal shutdown without stopping the array.
	This is equivalent to the 'Maintenance' mode of array operation, but drives are mounted.
	After this is done, you should not see any processes left running with open files that would prevent a shutdown.
	If there are any processes left running that will prevent a shutdown, you can Kill the processes, but you should really troubleshoot why the process is holding the files open and solve that problem so a normal shutdown can occur from the webgui.
	<p>After the array processes are stopped, you can stop the array and shut it down normally, or you can stop the array and then restart it.
	Just go to the 'Main->Array Operation' tab aand choose the operation.</p>
	<p>If you don't understand what is going on, you can go to 'Tools->Diagnostics' and capture information that can be posted on the LimeTech forum for others to help you in diagnosing the shutdown problem.</p>
	<p><strong>Note:</strong> This procedure is not intended to be a normal array shutdown.
	It is only intended to be a troubleshooting tool.</p>
	</blockquote>
	<div style="position:relative;float:left;width:50%;text-align:left; margin-bottom:24px">
		<form name="StopArrayProcesses" method="POST" action="/update.htm" target="progressFrame">
			<input type="hidden" name="cmd" value="/plugins/open.files/scripts/stop_array_processes">
			<input type="submit" name="runCmd" value="Stop Array Processes" disabled>
			<input type="checkbox" name="confirmStop" value="OFF" onClick="StopArrayProcesses.runCmd.disabled=!confirmStop.checked"><small>Yes I want to do this</small>
		</form>
	</div>
<?else:?>
	<p>Array is stopped!</p>
<?endif;?>
</div>

<script type="text/javascript">
$(function(){
	$('#tblOpenFiles').tablesorter({headers:{2:{sorter:false},3:{sorter:false}}});
});
</script>
